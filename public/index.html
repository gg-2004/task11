<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revolt Motors AI Chat</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .chat-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .chat-header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .chat-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .status-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 12px;
            height: 12px;
            background: #2ecc71;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.bot .message-content {
            background: white;
            color: #333;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            font-size: 18px;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .message.bot .message-avatar {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .send-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .send-btn:hover {
            transform: translateY(-2px);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .interrupt-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
        }

        .interrupt-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #ff5252, #d84315);
        }

        .interrupt-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: none;
            padding: 15px 20px;
            background: white;
            border-radius: 20px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .typing-dots {
            display: flex;
            gap: 5px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .welcome-message h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .start-conversation-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
            transition: transform 0.2s ease;
        }

        .start-conversation-btn:hover {
            transform: translateY(-2px);
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid #fcc;
        }

        .system-info {
            background: #e3f2fd;
            color: #1976d2;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid #bbdefb;
            font-size: 14px;
        }

        .interruption-message {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 1px solid #ffc107;
            border-radius: 10px;
            margin: 10px 0;
            padding: 15px;
            text-align: center;
            color: #856404;
            font-weight: 500;
        }

        .interruption-message i {
            margin-right: 8px;
            color: #ff6b6b;
        }

        .test-interrupt-btn {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
        }

        .test-interrupt-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #00a085, #008f7a);
        }

        .test-interrupt-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .debug-btn {
            background: linear-gradient(135deg, #4a148c, #311b92);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
        }

        .debug-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #311b92, #283593);
        }

        .debug-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        @media (max-width: 768px) {
            .chat-container {
                height: 90vh;
                margin: 10px;
            }
            
            .message-content {
                max-width: 85%;
            }
            
            .chat-header h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="status-indicator"></div>
            <h1><i class="fas fa-motorcycle"></i> Revolt Motors AI Chat</h1>
            <p>Your personal AI assistant for all things Revolt Motors</p>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="welcome-message">
                <h3>Welcome to Revolt Motors AI Chat!</h3>
                <p>I'm your dedicated AI assistant, specialized in everything about Revolt Motors electric vehicles.</p>
                <p>I can help you with:</p>
                <ul style="text-align: left; display: inline-block; margin: 15px 0;">
                    <li>Product information and specifications</li>
                    <li>Company history and achievements</li>
                    <li>Dealership and service center details</li>
                    <li>Electric vehicle technology insights</li>
                </ul>
                <button class="start-conversation-btn" onclick="startConversation()">
                    <i class="fas fa-play"></i> Start Conversation
                </button>
            </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
            <span style="margin-left: 10px; color: #666;">AI is typing...</span>
        </div>

        <div class="chat-input-container">
            <div class="input-group">
                <input type="text" 
                       class="chat-input" 
                       id="messageInput" 
                       placeholder="Ask me about Revolt Motors..." 
                       disabled>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
                    <i class="fas fa-paper-plane"></i> Send
                </button>
                <button class="interrupt-btn" id="interruptBtn" onclick="interruptResponse()" disabled style="display: none;">
                    <i class="fas fa-stop"></i> Stop
                </button>
                <button class="test-interrupt-btn" id="testInterruptBtn" onclick="testInterruption()" disabled>
                    <i class="fas fa-play"></i> Test Interruption
                </button>
                <button class="debug-btn" id="debugBtn" onclick="debugState()" style="display: inline-flex;">
                    <i class="fas fa-bug"></i> Debug
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = null;
        let isTyping = false;
        let isStreaming = false;
        let currentResponseText = '';

        async function testInterruption() {
            if (!currentSessionId) return;
            
            console.log('üß™ Starting test interruption...');
            console.log('üîÑ Current streaming state:', isStreaming);
            
            // Show typing indicator and enable interruption
            showTypingIndicator();
            enableInterruption();
            
            try {
                console.log('üîÑ Starting test streaming request...');
                // Use test interruption endpoint
                const response = await fetch('/api/test-interruption', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: currentSessionId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                console.log('‚úÖ Test streaming response started');
                // Handle streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                currentResponseText = '';
                
                // Create bot message container
                const botMessageDiv = createBotMessageContainer();
                
                try {
                    while (true) {
                        const { done, value } = await reader.read();
                        
                        if (done) break;
                        
                        const chunk = decoder.decode(value);
                        currentResponseText += chunk;
                        
                        // Update the bot message with streaming text
                        updateBotMessage(botMessageDiv, currentResponseText);
                    }
                    
                    console.log('‚úÖ Test streaming completed normally');
                    // Finalize the message if not interrupted
                    if (isStreaming) {
                        finalizeBotMessage(botMessageDiv, currentResponseText);
                    }
                } catch (streamError) {
                    console.log('‚ö†Ô∏è Test stream interrupted or error occurred:', streamError);
                    // Check if this was an intentional interruption
                    if (!isStreaming) {
                        console.log('‚úÖ Test response was intentionally interrupted');
                        // Response was interrupted, add indicator
                        const content = botMessageDiv.querySelector('.message-content');
                        content.innerHTML += ' <span style="color: #ff6b6b; font-style: italic;">[Response interrupted]</span>';
                        botMessageDiv.id = '';
                    }
                } finally {
                    console.log('üßπ Cleaning up test streaming state');
                    // Always clean up
                    hideTypingIndicator();
                    disableInterruption();
                }
                
            } catch (error) {
                console.error('‚ùå Error in test interruption:', error);
                hideTypingIndicator();
                disableInterruption();
                
                showError('Test interruption failed. Please try again.');
            }
        }

        async function startConversation() {
            try {
                const response = await fetch('/api/start-conversation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (data.sessionId) {
                    currentSessionId = data.sessionId;
                    
                    // Enable input
                    document.getElementById('messageInput').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    document.getElementById('testInterruptBtn').disabled = false; // Enable test interruption button
                    
                    // Clear welcome message and add system info
                    document.getElementById('chatMessages').innerHTML = `
                        <div class="system-info">
                            <strong>System Instructions:</strong> ${data.systemInstructions}
                        </div>
                        <div class="message bot">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                Hello! I'm excited to tell you all about Revolt Motors! We're India's first electric motorcycle manufacturer, revolutionizing the two-wheeler industry with cutting-edge electric technology. What would you like to know about our amazing electric motorcycles?
                            </div>
                        </div>
                    `;
                    
                    // Focus on input
                    document.getElementById('messageInput').focus();
                }
            } catch (error) {
                console.error('Error starting conversation:', error);
                showError('Failed to start conversation. Please try again.');
            }
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !currentSessionId || isStreaming) return;
            
            console.log('üì§ Sending message:', message);
            console.log('üîÑ Current streaming state:', isStreaming);
            
            // Add user message to chat
            addMessage(message, 'user');
            messageInput.value = '';
            
            // Show typing indicator and enable interruption
            showTypingIndicator();
            enableInterruption();
            
            try {
                console.log('üîÑ Starting streaming request...');
                // Use streaming endpoint for better interruption support
                const response = await fetch('/api/send-message-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: currentSessionId,
                        message: message
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                console.log('‚úÖ Streaming response started');
                // Handle streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                currentResponseText = '';
                
                // Create bot message container
                const botMessageDiv = createBotMessageContainer();
                
                try {
                    while (true) {
                        const { done, value } = await reader.read();
                        
                        if (done) break;
                        
                        const chunk = decoder.decode(value);
                        currentResponseText += chunk;
                        
                        // Update the bot message with streaming text
                        updateBotMessage(botMessageDiv, currentResponseText);
                    }
                    
                    console.log('‚úÖ Streaming completed normally');
                    // Finalize the message if not interrupted
                    if (isStreaming) {
                        finalizeBotMessage(botMessageDiv, currentResponseText);
                    }
                } catch (streamError) {
                    console.log('‚ö†Ô∏è Stream interrupted or error occurred:', streamError);
                    // Check if this was an intentional interruption
                    if (!isStreaming) {
                        console.log('‚úÖ Response was intentionally interrupted');
                        // Response was interrupted, add indicator
                        const content = botMessageDiv.querySelector('.message-content');
                        content.innerHTML += ' <span style="color: #ff6b6b; font-style: italic;">[Response interrupted]</span>';
                        botMessageDiv.id = '';
                    }
                } finally {
                    console.log('üßπ Cleaning up streaming state');
                    // Always clean up
                    hideTypingIndicator();
                    disableInterruption();
                }
                
            } catch (error) {
                console.error('‚ùå Error sending message:', error);
                hideTypingIndicator();
                disableInterruption();
                
                // Show a helpful error message
                let errorMessage = 'I encountered an issue processing your request. ';
                if (error.message.includes('fetch')) {
                    errorMessage += 'Please check your internet connection and try again.';
                } else if (error.message.includes('HTTP error')) {
                    errorMessage += 'The server is experiencing issues. Please try again in a moment.';
                } else {
                    errorMessage += 'Please try again or ask a different question about Revolt Motors.';
                }
                
                showError(errorMessage);
                
                // Add a helpful fallback response
                setTimeout(() => {
                    addMessage("Let me tell you about Revolt Motors! We're India's first electric motorcycle manufacturer with innovative models like the RV400 and RV300. What would you like to know about our electric vehicles?", 'bot');
                }, 1000);
            }
        }

        function createBotMessageContainer() {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.id = 'current-bot-message'; // Temporary ID for interruption handling
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = '<i class="fas fa-robot"></i>';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            content.textContent = '';
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return messageDiv;
        }

        function updateBotMessage(messageDiv, text) {
            const content = messageDiv.querySelector('.message-content');
            content.textContent = text;
            messageDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function finalizeBotMessage(messageDiv, text) {
            // Remove temporary ID
            messageDiv.id = '';
            
            // Final update
            const content = messageDiv.querySelector('.message-content');
            content.textContent = text;
            
            // Scroll to bottom
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
        }

        async function interruptResponse() {
            console.log('üõë Interrupt button clicked');
            console.log('Current session ID:', currentSessionId);
            console.log('Is streaming:', isStreaming);
            
            if (!currentSessionId) {
                console.log('‚ùå No session ID');
                return;
            }
            
            if (!isStreaming) {
                console.log('‚ùå Not currently streaming');
                return;
            }
            
            try {
                console.log('üîÑ Sending interrupt request...');
                const response = await fetch('/api/interrupt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: currentSessionId
                    })
                });

                const data = await response.json();
                console.log('üì° Interrupt response:', data);
                
                if (data.success) {
                    console.log('‚úÖ Response interrupted successfully');
                    
                    // Add interruption indicator to the current message
                    const currentMessage = document.getElementById('current-bot-message');
                    if (currentMessage) {
                        const content = currentMessage.querySelector('.message-content');
                        content.innerHTML += ' <span style="color: #ff6b6b; font-style: italic;">[Response interrupted]</span>';
                        currentMessage.id = ''; // Remove temporary ID
                    }
                    
                    hideTypingIndicator();
                    disableInterruption();
                    
                    // Show interruption message
                    showInterruptionMessage();
                } else {
                    console.log('‚ö†Ô∏è No active response to interrupt');
                }
            } catch (error) {
                console.error('‚ùå Error interrupting response:', error);
                // Even if there's an error, try to reset the UI state
                hideTypingIndicator();
                disableInterruption();
            }
        }

        function showInterruptionMessage() {
            const chatMessages = document.getElementById('chatMessages');
            const interruptionDiv = document.createElement('div');
            interruptionDiv.className = 'interruption-message';
            interruptionDiv.innerHTML = `
                <div style="text-align: center; padding: 10px; color: #ff6b6b; font-style: italic;">
                    <i class="fas fa-stop-circle"></i> Response interrupted. You can ask a new question.
                </div>
            `;
            chatMessages.appendChild(interruptionDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function enableInterruption() {
            console.log('üîÑ Enabling interruption mode');
            isStreaming = true;
            const interruptBtn = document.getElementById('interruptBtn');
            interruptBtn.style.display = 'inline-flex';
            interruptBtn.disabled = false; // Enable the button
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('testInterruptBtn').disabled = true;
            console.log('‚úÖ Interruption enabled - Stop button visible and enabled');
        }

        function disableInterruption() {
            console.log('üîÑ Disabling interruption mode');
            isStreaming = false;
            const interruptBtn = document.getElementById('interruptBtn');
            interruptBtn.style.display = 'none';
            interruptBtn.disabled = true; // Disable the button
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('testInterruptBtn').disabled = false;
            console.log('‚úÖ Interruption disabled - Stop button hidden and disabled');
        }

        function addMessage(text, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = sender === 'user' ? 
                '<i class="fas fa-user"></i>' : 
                '<i class="fas fa-robot"></i>';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            content.textContent = text;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            if (!isTyping) {
                document.getElementById('typingIndicator').style.display = 'block';
                isTyping = true;
                document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
            }
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
            isTyping = false;
        }

        function showError(message) {
            const chatMessages = document.getElementById('chatMessages');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            chatMessages.appendChild(errorDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function debugState() {
            console.log('=== Debug State ===');
            console.log('Current Session ID:', currentSessionId);
            console.log('Is Typing:', isTyping);
            console.log('Is Streaming:', isStreaming);
            console.log('Current Response Text:', currentResponseText);
            console.log('Interrupt Button Visibility:', document.getElementById('interruptBtn').style.display);
            console.log('Interrupt Button Disabled:', document.getElementById('interruptBtn').disabled);
            console.log('Send Button Disabled:', document.getElementById('sendBtn').disabled);
            console.log('Test Interruption Button Disabled:', document.getElementById('testInterruptBtn').disabled);
            console.log('Message Input Disabled:', document.getElementById('messageInput').disabled);
            console.log('=== End Debug ===');
        }

        // Handle Enter key
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !isStreaming) {
                sendMessage();
            }
        });

        // Check server health on load
        window.addEventListener('load', async () => {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                console.log('Server health:', data);
            } catch (error) {
                console.error('Server health check failed:', error);
            }
        });
    </script>
</body>
</html>

